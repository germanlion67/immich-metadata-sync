# Feature Request: Album Metadata Synchronization

## üìã Overview
Add support for synchronizing Immich album information into XMP metadata fields, allowing albums to be preserved when exporting/importing photos to/from other photo management tools.

## üéØ Motivation
Currently, the sync tool writes people, GPS, captions, timestamps, and ratings to EXIF/XMP fields, but **album assignments are not preserved**. Users who organize their photos in albums within Immich lose this organization when exporting files or using other tools that read XMP metadata.

## üîç Current Limitation
The Immich API endpoints currently used (`/assets/{id}`, `/assets/batch`) **do not include album information** in their responses. Albums must be fetched separately using:
- `GET /albums?assetId={id}` - Returns albums containing a specific asset
- `GET /albums` - Returns all albums (can be cached for performance)

## üí° Proposed Solution

### Option 1: Per-Asset Album Lookup (Simple)
```python
def get_albums_for_asset(asset_id: str, headers: Dict, base_url: str, log_file: str) -> List[str]:
    """Fetch album names that contain this asset."""
    response = api_call("GET", f"/albums?assetId={asset_id}", headers, base_url, log_file)
    if response and isinstance(response, list):
        return [album.get("albumName") for album in response if album.get("albumName")]
    return []
```

**Pros:** Simple implementation  
**Cons:** +1 API call per asset (could be slow for large libraries)

### Option 2: Cached Album Map (Recommended)
```python
def build_asset_album_map(headers: Dict, base_url: str, log_file: str) -> Dict[str, List[str]]:
    """Build a map of asset_id -> [album_names] by fetching all albums once."""
    all_albums = api_call("GET", "/albums", headers, base_url, log_file)
    
    asset_to_albums = {}
    for album in all_albums or []:
        album_name = album.get("albumName")
        if not album_name:
            continue;
            
        for asset in album.get("assets", []):
            asset_id = asset.get("id")
            if asset_id:
                if asset_id not in asset_to_albums:
                    asset_to_albums[asset_id] = []
                asset_to_albums[asset_id].append(album_name)
    
    return asset_to_albums
```

**Pros:** Only 1 API call total, much faster  
**Cons:** Slightly more complex, requires memory for album map

## üìù Recommended XMP Fields

### Primary Field: XMP-iptcExt:Event
```python
# Use the first/primary album as the Event field (IPTC Extension standard)
if albums and len(albums) > 0:
    args.append(f"-XMP-iptcExt:Event={albums[0]}")
```

### Secondary Field: XMP:HierarchicalSubject
```python
# Store all albums as hierarchical keywords for better organization
if albums:
    hierarchical = [f"Albums|{name}" for name in albums]
    args.append(f"-XMP:HierarchicalSubject={','.join(hierarchical)}")
```

**Why these fields?**
- `XMP-iptcExt:Event` is the IPTC Extension standard for event/album names
- `XMP:HierarchicalSubject` provides hierarchical keywords (supported by Lightroom, DigiKam, etc.)
- These fields do NOT conflict with existing people tagging in `XMP:Subject`

## üõ†Ô∏è Implementation Plan

### 1. Add CLI Flag
```python
parser.add_argument("--albums", action="store_true", help="Sync album information to XMP metadata")
```

### 2. Extend `build_exif_args()` Function
```python
# 6. ALBUM SYNC (new section after rating)
if "albums" in active_modes:
    album_names = album_map.get(asset.get("id"), [])
    if album_names:
        # Primary album as Event
        args.append(f"-XMP-iptcExt:Event={album_names[0]}")
        
        # All albums as hierarchical keywords
        hierarchical = [f"Albums|{name}" for name in album_names]
        args.append(f"-XMP:HierarchicalSubject={','.join(hierarchical)}")
        
        changes.append("Albums")
```

### 3. Integrate into `main()` Function
```python
def main():
    # ... existing code ...
    
    # Build album map if needed (before processing assets)
    album_map = {}
    if "albums" in active_modes:
        log("Fetching album information...", log_file, LogLevel.INFO)
        album_map = build_asset_album_map(headers, base_url, log_file)
        log(f"Loaded {len(album_map)} assets with album assignments", log_file, LogLevel.INFO)
    
    # Pass album_map to process_asset()
    for chunk in chunked(assets, batch_size):
        # ... process with album_map ...
```

### 4. Update Change Detection
Extend `get_current_exif_values()` to read album fields:
```python
if "albums" in active_modes:
    tags_to_read.extend(["Event", "HierarchicalSubject"])
```

### 5. Update Documentation
- Add album sync description to README.md
- Update usage examples with `--albums` flag
- Document XMP fields used for albums

## üé® Example Usage

```bash
# Sync all metadata including albums
python3 immich-ultra-sync.py --all --albums

# Sync only people and albums
python3 immich-ultra-sync.py --people --albums

# Check what would be synced (dry-run)
python3 immich-ultra-sync.py --all --albums --dry-run --only-new
```

## ‚úÖ Acceptance Criteria

- [ ] Albums are fetched from Immich API efficiently (preferably with caching)
- [ ] Album names are written to `XMP-iptcExt:Event` and `XMP:HierarchicalSubject`
- [ ] `--albums` CLI flag is added and documented
- [ ] Change detection works with `--only-new` flag for album fields
- [ ] Performance impact is minimal (single API call for all albums)
- [ ] README and documentation updated
- [ ] Unit tests added for album synchronization

## üîó Related

- Issue #1 - Base request for extended metadata fields
- Future: Phase 3 - Face region coordinates (mwg-rs)

## üìä Estimated Effort

- **Implementation:** 2-3 hours
- **Testing:** 1 hour
- **Documentation:** 30 minutes
- **Total:** ~4 hours